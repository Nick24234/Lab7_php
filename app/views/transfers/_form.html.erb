<%= form_with(model: transfer, local: true) do |form| %>
  <% if transfer.errors.any? %>
    <div class="alert alert-danger" role="alert">
      <h4 class="alert-heading">–í–∏—è–≤–ª–µ–Ω–æ <%= pluralize(transfer.errors.count, "–ø–æ–º–∏–ª–∫—É") %>:</h4>
      <ul class="mb-0" style="margin-top: 10px; padding-left: 20px;">
        <% transfer.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% if transfer.new_record? && user_signed_in? %>
    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
      <strong>üë§ –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫:</strong> <%= current_user.nickname %>
      <br>
      <strong>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å:</strong> <%= number_to_currency(current_user.balance, unit: "‚Ç¥", separator: ",", delimiter: " ") %>
    </div>
  <% elsif !transfer.new_record? && transfer.sender && transfer.receiver %>
    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
      <strong>üë§ –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫:</strong> <%= transfer.sender.nickname %>
      <br>
      <strong>üë§ –û—Ç—Ä–∏–º—É–≤–∞—á:</strong> <%= transfer.receiver.nickname %>
    </div>
  <% end %>

  <div class="form-group">
    <%= form.label :receiver_id, "–û—Ç—Ä–∏–º—É–≤–∞—á" %>
    <% if transfer.new_record? && user_signed_in? %>
      <%= form.collection_select :receiver_id, 
          User.where.not(id: current_user.id).order(:nickname), 
          :id, 
          lambda { |u| "#{u.nickname} (–ë–∞–ª–∞–Ω—Å: #{number_to_currency(u.balance, unit: '‚Ç¥', separator: ',', delimiter: ' ')})" },
          { prompt: "–û–±–µ—Ä—ñ—Ç—å –æ—Ç—Ä–∏–º—É–≤–∞—á–∞" },
          { class: 'form-control', style: 'padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;', required: true } %>
    <% elsif !transfer.new_record? %>
      <%= form.collection_select :receiver_id, 
          User.all.order(:nickname), 
          :id, 
          lambda { |u| "#{u.nickname} (–ë–∞–ª–∞–Ω—Å: #{number_to_currency(u.balance, unit: '‚Ç¥', separator: ',', delimiter: ' ')})" },
          {},
          { class: 'form-control', style: 'padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;', required: true } %>
    <% end %>
    <% if transfer.errors[:receiver_id].any? %>
      <div class="error-message"><%= transfer.errors[:receiver_id].first %></div>
    <% end %>
    <small style="color: #6c757d; display: block; margin-top: 5px;">
      –û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–º—É –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–∫–∞–∑–∞—Ç–∏ –∫–æ—à—Ç–∏
    </small>
  </div>

  <div class="form-group">
    <%= form.label :amount, "–°—É–º–∞ –ø–µ—Ä–µ–∫–∞–∑—É" %>
    <% if transfer.new_record? && user_signed_in? %>
      <%= form.number_field :amount, step: 0.01, placeholder: "–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É", min: 0.01, max: current_user.balance, required: true %>
      <small style="color: #6c757d; display: block; margin-top: 5px;">
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Å—É–º–∞: <%= number_to_currency(current_user.balance, unit: "‚Ç¥", separator: ",", delimiter: " ") %>
      </small>
    <% else %>
      <%= form.number_field :amount, step: 0.01, placeholder: "–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É", min: 0.01, required: true %>
    <% end %>
    <% if transfer.errors[:amount].any? %>
      <div class="error-message"><%= transfer.errors[:amount].first %></div>
    <% end %>
  </div>

  <% unless transfer.new_record? %>
    <div class="form-group">
      <%= form.label :status, "–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–∫–∞–∑—É" %>
      <%= form.select :status, 
          options_for_select([
            ['‚è≥ –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è', 'pending'],
            ['‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 'completed'],
            ['‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ', 'cancelled']
          ], transfer.status),
          {},
          { class: 'form-control', style: 'padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;' } %>
    </div>
  <% end %>

  <div class="form-actions">
    <% if user_signed_in? %>
      <%= form.submit transfer.new_record? ? '–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä–µ–∫–∞–∑' : '–û–Ω–æ–≤–∏—Ç–∏ –ø–µ—Ä–µ–∫–∞–∑', class: 'btn btn-success' %>
    <% end %>
    <%= link_to '–°–∫–∞—Å—É–≤–∞—Ç–∏', transfers_path, class: 'btn btn-secondary' %>
  </div>
<% end %>


